---
name: Build and Test

"on":
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
    tags:
      - '*'
    paths-ignore:
      - '.github/**'
      - '.gitignore'
      - '**.md'

permissions: write-all

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: chipwolf/badgesort

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      with:
        fetch-depth: 1
    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov
    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=badgesort --cov-report=term-missing
  image:
    name: Build Image
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      with:
        fetch-depth: 1
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and cache Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
      with:
        context: .
        push: ${{ github.event_name == 'push' }}
        tags: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}"
        cache-from: type=gha
        cache-to: type=gha,mode=max
  badgesort:
    name: Run BadgeSort
    needs: [image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 1
      - name: Demo 1
        uses: ./
        with:
          format: markdown
          id: default
          output: README.md
          slugs: |
            osu
            github
            americanexpress
            nodered
            opensea
          sort: hilbert
          style: for-the-badge
      - name: Demo 2
        uses: ./
        with:
          format: html
          id: foobar
          output: README.md
          random: 5
          sort: false
          style: flat-square
      - name: Demo 3
        uses: ./
        with:
          opts: |
            --hue-rotate 240
          id: example
          format: html
          output: README.md
          sort: step_invert
          style: flat
          slugs: |
            angular,apollographql,brave,d3dotjs,docker
            git,githubactions,googlecloud,graphql,heroku
            html5,insomnia,mongodb,nestjs,nodedotjs
            npm,prettier,react,reactivex,redux
            rollupdotjs,sass,styledcomponents,typescript,webpack
      - name: Commit and push
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        with:
          default_author: github_actions
          message: 'chore(docs): refresh badgesort'
